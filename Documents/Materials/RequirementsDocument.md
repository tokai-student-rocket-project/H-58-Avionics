# 要件定義書

H-58 搭載計器の要件定義、及びシステムの概要について記載する。

## 概要

### 要件

- 海打ち 2 段階分離に対応
- ±200g, 1kHz の加速度計測
- 熱電対による充填確認
- 統合システムとデータバスの実証
- 高速ダウンリンクの実証

### システム構成

- Nucleo-STM32F303K8
- CAN-BUS
- 計測系
  - 加速度/ジャイロ/地磁気
  - クオータニオン
  - 線形加速度
  - 姿勢角
  - 高 g 加速度
  - 気圧
  - 気温
  - 電圧
  - GNSS
- データ処理系
  - 速度算出
  - 高度算出
  - 出力
    - SD カード
    - EEPROM
- 制御系
  - バルブ制御
  - 分離制御
  - フライトモード
  - 状態検知
    - リフトオフ検知
    - 燃焼終了検知
    - 頂点検知
    - 開傘検知
    - 着地検知
- 通信系
  - 1kHz ダウンリンク
  - 慣性情報ダウンリンク
  - 高度情報ダウンリンク
  - 制御情報ダウンリンク
  - 汎用アップリンク
- 電源系
  - 12V パワーライン
  - 5V パワーライン
  - 電池ボックス
  - 変圧基板
  - 12V バルブ電源
- 構造系
  - 計器タワー
  - 水密
  - THR 制御モジュール
  - 搭載カメラ

## モジュール

従来の共通計器, テレメータの統合を行い、各機能をモジュールとして分割して開発を行う。

システムを構成するモジュールは以下の通りである。

- 計測モジュール
- 飛翔管理モジュール
- 通信モジュール
- THR 制御モジュール

各モジュールはプロセッサとして Nucleo-STM32F303K8 を積む。また、各モジュールは CAN-BUS を通して通信を行う。

CAN-BUS を使用したモジュール式のシステムとすることで、高い拡張性と疎結合による高い運用性を期待できる。

Nucleo-STM32F303K8 のマイコンである STM32F303 は、H-57 に搭載した Arduino MKR WAN 1310 の ATSAMD21 と比較して特段性能が高いわけではないが、より高性能なマイコンを有する STM シリーズの開発運用経験を蓄積することができる。これに加えて、ATSAMD21 と STM32F303 は同じ ARM コアであるため、プログラムの互換性があり学習コストが低く、Arduino から STM のステップアップとして最適であると考える。

|              | ATSAMD21                          | STM32F303                                  |
| ------------ | --------------------------------- | ------------------------------------------ |
| 動作周波数   | 48MHz                             | 72MHz                                      |
| ビット数     | 32bit                             | 32bit                                      |
| コアの数     | シングルコア                      | シングルコア                               |
| コアの種類   | ARM® Cortex®-M0+                  | ARM® Cortex®-M4                            |
| Flash サイズ | 256kB                             | 64kB                                       |
| RAM サイズ   | 32kB                              | 16kB                                       |
| 接続性       | I²C, LINbus, SPI, UART/USART, USB | CANbus, I²C, IrDA, LINbus, SPI, UART/USART |

## 計測系

GNSS は通信モジュールで行われ、それ以外は計測モジュールで計測する。

計測するデータと計測レートは以下の通りである。

なお、クオータニオン, 線形加速度, 姿勢角はセンサ内で算出される(NDOF=NineDegreesOfFreedom)ため、計測系として扱う。

また、出力データはデータ処理系に送り、SD, EEPROM に保存されるほか、通信系に送りダウンリンクする。

| データ         | センサ         | レート | 出力先           |
| -------------- | -------------- | ------ | ---------------- |
| 加速度         | BNO055         | 100Hz  | SD, ダウンリンク |
| ジャイロ       | BNO055         | 100Hz  | SD, ダウンリンク |
| 地磁気         | BNO055         | 100Hz  | SD, ダウンリンク |
| クオータニオン | BNO055 (NDOF)  | 100Hz  | SD, ダウンリンク |
| 線形加速度     | BNO055 (NDOF)  | 100Hz  | SD, ダウンリンク |
| 姿勢角         | BNO055 (NDOF)  | 100Hz  | SD, ダウンリンク |
| 高 g 加速度    | ADXL375        | 1kHz   | EEPROM           |
| 気圧           | LPS33HW        | 100Hz  | SD, ダウンリンク |
| 気温           | サーミスタ ADC | 2Hz    | SD, ダウンリンク |
| 電圧           | ADC            | 10Hz   | SD, ダウンリンク |
| GNSS           | SAM-M8Q        | 10Hz   | SD, ダウンリンク |

## データ処理系

主に計測系で得たデータを処理する。

### 速度算出

線形加速度を経過時間で積分することで求める。

### 高度算出

計測した気圧と気温、及び打ち上げ前に設定する海面気圧から求める。

### 出力

計測や算出した値は以下の 3 通りの出力先に送信される。

- SD
- EEPROM
- ダウンリンク

基本的に全てのデータを SD に保存するとともに、通信系からダウンリンクで地上に送信する。
海打ちの H-58 では、水没や損傷によるデータロストを防ぐためにダウンリンクに重点を置いている。

高 g 加速度のみ計測レートが大きいため EEOROM に保存する。EEPROM は海打ちで実質弾道落下となり水没した H-49 でもデータの保持に成功している。

データの出力に必要な通信速度は以下の通りである。

| 出力先       | 通信速度  |
| ------------ | --------- |
| SD           | 38.4 kbps |
| EEPROM       | 48 kbps   |
| ダウンリンク | 38.4 kbps |

なお、通信速度は値を符号なし 8bit 整数 2 つとみて、生のまま送信した場合である。実際は、パケットに Id や CRC が含まれるため、さらに通信速度は必要になる。

ダウンリンクはデータが経由する CAN-BUS と LoRa でそれぞれ必要になる通信速度である。

## 制御系

制御系はバルブ制御と分離制御、内部制御用のフライトモードと状態検知からなる。

### バルブ制御

THR 制御モジュールで行い、GSE のバルブ開閉信号を受信してバルブシステムのサーボモータを制御する。
サーボモータの制御には RS485 通信を使う。

### 分離制御

不知火の電磁弁に分離信号の DC12V を供給することで分離させる。
H-58 では 2 段階分離となるため、不知火 Ⅲ を頂点、不知火 Ⅳ を指定高度で動作させる。

## 通信系

LoRa による搭載計器地上局間の通信を 5 系統用意する。そのうち 2 系統はダウンリンク用、1 系統はアップリンク用である。

通信モジュールのみプロセッサに Nucleo-STM32F303K8 ではなく Arduino MKR WAN 1310 を使用する。

### 1kHz ダウンリンク

燃焼中3秒間程度の1kHz加速度情報を1分程度かけてダウンリンクする

### 慣性情報ダウンリンク

BNO055から出力される慣性データをダウンリンクする

### 高度情報ダウンリンク

気圧や気温、算出された高度データをダウンリンクする

### 制御情報ダウンリンク

フライトモードやステータスなどの制御情報をダウンリンクする

### 汎用アップリンク

地上局からのコマンドを受信する

## 電源系

### 12V パワーライン

Nucleo-STM32F303K8 は VIN に 12V を受け付けるため、電池ボックスが出力する 15V を変圧基板で 12V へ変圧して各モジュールに供給する。

### 5V パワーライン

Arduino MKR WAN 1310 と搭載カメラを制御する Raspberry Pi は駆動に 5V を要するため、変圧基板で 5V へ変圧して供給する。

### 電池ボックス

3V 出力が可能な CR123A を 5 個直列接続して 15V 出力の電池ボックスとする。電池容量が不足する場合は、電池ボックスを並列接続する。

### 変圧基板

複数個の 3 端子レギュレータで電池ボックスが出力する 15V を 12V と 5V に変圧する。

12V パワーラインと 5V パワーラインは外部給電を設けずに、電源投入時にスイッチで電池ボックスと変圧基板を接続する。

### 12V バルブ電源

バルブ駆動用電源は別系統として、外部給電を行う。内部電源と外部電源は THR 制御モジュール内で切り替える。

## 構造系

### 計器タワー

衝撃に耐えるために、スペーサーを上下のカプラに接続する蓋で固定する両端固定梁の構造とする。
上下の蓋は従来のベークライトではなく、ガラスエポキシを試す。

### 水密

機体チューブの 1 重構造として、上下のカプラ部分に防水用の構造を取り付ける。

### THR 制御モジュール

バルブ制御は燃焼関係の計測を行う THR 制御モジュールの基板は計器タワーではなくバルブ付近に搭載する。

### 搭載カメラ

機体外を撮影するカメラを搭載する。カメラには Raspberry Pi のカメラモジュールを使用する。

# 要件定義書

H-58 搭載計器の要件定義、及びシステムの概要について記載する。

## 概要

### 要件

- 海打ち 2 段階分離に対応
- ±200g, 1kHz の加速度計測
- 熱電対による充填確認
- 統合システムとデータバスの実証
- 高速ダウンリンクの実証

### システム構成

- Nucleo-STM32F303K8
- CAN-BUS
- 計測系
  - 加速度/ジャイロ/地磁気
  - クオータニオン
  - 線形加速度
  - 姿勢角
  - 高 g 加速度
  - 気圧
  - 気温
  - 電圧
  - GNSS
- データ処理系
  - 速度算出
  - 高度算出
  - 出力
    - SD カード
    - EEPROM
- 制御系
  - バルブ制御
  - 分離制御
  - フライトモード
  - 状態検知
    - リフトオフ検知
    - 燃焼終了検知
    - 頂点検知
    - 開傘検知
    - 着地検知
- 通信系
  - LoRa
    - 高速ダウンリンク
    - 低速ダウンリンク
    - アップリンク
- 電源系
  - 12V パワーライン
  - 5V パワーライン
  - 電池ボックス
  - 変圧基板
  - 12V バルブ電源
- 構造系
  - 計器タワー
  - 水密
  - THR制御モジュール
  - 搭載カメラ

## モジュール

従来の共通計器, テレメータの統合を行い、各機能をモジュールとして分割して開発を行う。

システムを構成するモジュールは以下の通りである。

- 計測モジュール
- 飛翔管理モジュール
- 通信モジュール
- THR 制御モジュール

各モジュールはプロセッサとして Nucleo-STM32F303K8 を積む。また、各モジュールは CAN-BUS を通して通信を行う。

CAN-BUS を使用したモジュール式のシステムとすることで、高い拡張性と疎結合による高い運用性を期待できる。

Nucleo-STM32F303K8 のマイコンである STM32F303 は、H-57 に搭載した Arduino MKR WAN 1310 の ATSAMD21 と比較して特段性能が高いわけではないが、より高性能なマイコンを有する STM シリーズの開発運用経験を蓄積することができる。これに加えて、ATSAMD21 と STM32F303 は同じ ARM コアであるため、プログラムの互換性があり学習コストが低く、Arduino から STM のステップアップとして最適であると考える。

|              | ATSAMD21                          | STM32F303                                  |
| ------------ | --------------------------------- | ------------------------------------------ |
| 動作周波数   | 48MHz                             | 72MHz                                      |
| ビット数     | 32bit                             | 32bit                                      |
| コアの数     | シングルコア                      | シングルコア                               |
| コアの種類   | ARM® Cortex®-M0+                  | ARM® Cortex®-M4                            |
| Flash サイズ | 256kB                             | 64kB                                       |
| RAM サイズ   | 32kB                              | 16kB                                       |
| 接続性       | I²C, LINbus, SPI, UART/USART, USB | CANbus, I²C, IrDA, LINbus, SPI, UART/USART |

## 計測系

GNSS は通信モジュールで行われ、それ以外は計測モジュールで計測する。

計測するデータと計測レートは以下の通りである。

なお、クオータニオン, 線形加速度, 姿勢角はセンサ内で算出される(NDOF=NineDegreesOfFreedom)ため、計測系として扱う。

また、出力データはデータ処理系に送り、SD, EEPROM に保存されるほか、通信系に送りダウンリンクする。

| データ         | センサ         | レート | 出力先           |
| -------------- | -------------- | ------ | ---------------- |
| 加速度         | BNO055         | 100Hz  | SD, ダウンリンク |
| ジャイロ       | BNO055         | 100Hz  | SD, ダウンリンク |
| 地磁気         | BNO055         | 100Hz  | SD, ダウンリンク |
| クオータニオン | BNO055 (NDOF)  | 100Hz  | SD, ダウンリンク |
| 線形加速度     | BNO055 (NDOF)  | 100Hz  | SD, ダウンリンク |
| 姿勢角         | BNO055 (NDOF)  | 100Hz  | SD, ダウンリンク |
| 高 g 加速度    | ADXL375        | 1kHz   | EEPROM           |
| 気圧           | LPS33HW        | 100Hz  | SD, ダウンリンク |
| 気温           | サーミスタ ADC | 2Hz    | SD, ダウンリンク |
| 電圧           | ADC            | 10Hz   | SD, ダウンリンク |
| GNSS           | SAM-M8Q        | 10Hz   | SD, ダウンリンク |

## データ処理系

主に計測系で得たデータを処理する。

### 速度算出

線形加速度を経過時間で積分することで求める。

### 高度算出

計測した気圧と気温、及び打ち上げ前に設定する海面気圧から求める。

### 出力

計測や算出した値は以下の3通りの出力先に送信される。

- SD
- EEPROM
- ダウンリンク

基本的に全てのデータをSDに保存するとともに、通信系からダウンリンクで地上に送信する。
海打ちのH-58では、水没や損傷によるデータロストを防ぐためにダウンリンクに重点を置いている。

高g加速度のみ計測レートが大きいためEEOROMに保存する。EEPROMは海打ちで実質弾道落下となり水没したH-49でもデータの保持に成功している。

データの出力に必要な通信速度は以下の通りである。

|出力先|通信速度|
|-|-|
|SD|38.4 kbps|
|EEPROM|48 kbps|
|ダウンリンク|38.4 kbps|

なお、通信速度は値を符号なし8bit整数2つとみて、生のまま送信した場合である。実際は、パケットにIdやCRCが含まれるため、さらに通信速度は必要になる。

ダウンリンクはデータが経由するCAN-BUSとLoRaでそれぞれ必要になる通信速度である。

## 制御系

制御系はバルブ制御と分離制御、内部制御用のフライトモードと状態検知からなる。

### バルブ制御

THR制御モジュールで行い、GSEのバルブ開閉信号を受信してバルブシステムのサーボモータを制御する。
サーボモータの制御にはRS485通信を使う。

### 分離制御

不知火の電磁弁に分離信号のDC12Vを供給することで分離させる。
H-58では2段階分離となるため、不知火Ⅲを頂点、不知火Ⅳを指定高度で動作させる。

## 通信系

LoRaによる搭載計器地上局間の通信を3系統用意する。そのうち2系統はダウンリンク用、1系統はアップリンク用である。

通信モジュールのみプロセッサにNucleo-STM32F303K8ではなくArduino MKR WAN 1310を使用する。

### 高速ダウンリンク

高G加速度以外の全ての計測データを最大100Hzで送信する。着水時の計器の損傷によるデータロストに備え、データ回収のほとんどを無線で賄うことを実証する。

### 低速ダウンリンク

フライトモードや制御状況など、高頻度で送信する必要のないデータを送信する。

### アップリンク

地上局からのコマンドを受信する。離床前からの計測を行うための「フライトモードオン」コマンドや緊急分離コマンドを用意する。

## 電源系

### 12V パワーライン

Nucleo-STM32F303K8はVINに12Vを受け付けるため、電池ボックスが出力する15Vを変圧基板で12Vへ変圧して各モジュールに供給する。

### 5V パワーライン

Arduino MKR WAN 1310と搭載カメラを制御するRaspberry Piは駆動に5Vを要するため、変圧基板で5Vへ変圧して供給する。

### 電池ボックス

3V出力が可能なCR123Aを5個直列接続して15V出力の電池ボックスとする。電池容量が不足する場合は、電池ボックスを並列接続する。

### 変圧基板

複数個の3端子レギュレータで電池ボックスが出力する15Vを12Vと5Vに変圧する。

12Vパワーラインと5Vパワーラインは外部給電を設けずに、電源投入時にスイッチで電池ボックスと変圧基板を接続する。

### 12Vバルブ電源

バルブ駆動用電源は別系統として、外部給電を行う。内部電源と外部電源はTHR制御モジュール内で切り替える。

## 構造系

### 計器タワー

衝撃に耐えるために、スペーサーを上下のカプラに接続する蓋で固定する両端固定梁の構造とする。
上下の蓋は従来のベークライトではなく、ガラスエポキシを試す。

### 水密

機体チューブの1重構造として、上下のカプラ部分に防水用の構造を取り付ける。

### THR制御モジュール

バルブ制御は燃焼関係の計測を行うTHR制御モジュールの基板は計器タワーではなくバルブ付近に搭載する。

### 搭載カメラ

機体外を撮影するカメラを搭載する。カメラにはRaspberry Piのカメラモジュールを使用する。
